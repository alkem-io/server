# Implementation Plan: Postgres DB Convergence

**Branch**: `024-postgres-db-convergence` | **Date**: 2025-11-20 | **Spec**: `specs/024-postgres-db-convergence/spec.md`
**Input**: Feature specification from `/specs/024-postgres-db-convergence/spec.md`

**Note**: This plan is generated by the `/speckit.plan` workflow using `.github/prompts/speckit.plan.prompt.md`.

## Summary

Converge the Alkemio and Kratos relational backends onto Postgres as the only supported database, providing: (1) Postgres-only install paths for new environments, (2) a safe, documented migration procedure from existing MySQL deployments to Postgres for both Alkemio and Kratos, and (3) a validated, Postgres-compatible migration/baseline story for future environments.

## Technical Context

**Language/Version**: TypeScript 5.x on Node.js 20 LTS (NestJS server)
**Primary Dependencies**: NestJS, TypeORM, Ory Kratos, MySQL 8 (current), Postgres 17.5 (target), Docker Compose
**Storage**: MySQL 8 (source), Postgres 17.5 (target for Alkemio and Kratos)
**Testing**: Jest (`pnpm test:ci`), contract tests for schema/migrations, migration validation scripts
**Target Platform**: Linux containers (Kubernetes), local Docker Compose for development
**Project Type**: Backend service (single server project) with external Kratos service and DBs
**Performance Goals**: Migration procedure should complete within the target maintenance window (see SC-003) and not materially degrade runtime performance post-cut-over. For this iteration, validation is performed against a representative production snapshot rather than under live-traffic SLA conditions.
**Constraints**: Zero MySQL dependency in steady state for supported topologies; downtime for migration <= 30 minutes for typical production-sized installs; roll-forward or rollback strategy must be documented
**Scale/Scope**: Production datasets with potentially millions of records across Alkemio and Kratos schemas; multiple environments (dev/test/stage/prod) must be supported

## Constitution Check

_GATE: Must pass before Phase 0 research. Re-check after Phase 1 design._

- **Principle 1 (Domain-Centric Design)**: Changes to application behavior (e.g., handling Postgres-specific constraints, validation of migrated data) will be implemented in domain services and repositories under `src/domain`, with NestJS modules and resolvers/controllers only orchestrating flows. Any migration tooling embedded in the server will call into domain abstractions rather than performing raw SQL logic in controllers.
- **Principle 5 (Observability & Operational Readiness)**: We will rely on existing logging (Winston) and deployment observability for DB connectivity and migration status. Migration tooling must log structured progress events (start, per-phase checkpoints, completion/failure) with correlation IDs, and reuse existing alerting around application health and DB connectivity. No new metrics will be introduced unless wired into existing dashboards.
- **Principle 6 (Code Quality & Testing)**: Postgres convergence will be guarded by automated checks: updated migration validation scripts, schema contract tests (existing in `contract-tests/`), and focused integration tests for running against Postgres-only environments. Where manual, environment-scale verification is required (e.g., large production datasets), we will document explicit verification checklists and treat them as part of runbooks rather than trying to fully automate production-scale testing.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
src/
├── domain/
├── services/
├── core/
├── common/
└── library/

test/
├── contract/
├── functional/
└── unit/
```

**Structure Decision**: Single backend server (`src/**` + `test/**`) with domain-centric modules. This feature will primarily touch migrations/configuration, possible domain repositories/services, and documentation under `docs/` and `specs/024-postgres-db-convergence/`.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation                  | Why Needed         | Simpler Alternative Rejected Because |
| -------------------------- | ------------------ | ------------------------------------ |
| [e.g., 4th project]        | [current need]     | [why 3 projects insufficient]        |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient]  |
