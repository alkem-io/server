# ARC AutoScalingRunnerSet Helm values for gha-runner-scale-set chart.
#
# IMPORTANT: Uses full pod template instead of containerMode.type: "dind" shorthand.
# Reason: The simplified dind mode does not support custom volume mounts on the
# runner container (see https://github.com/actions/actions-runner-controller/issues/3281).
#
# Apply via Helm:
#   helm upgrade --install arc-runner-set \
#     oci://ghcr.io/actions/actions-runner-controller-charts/gha-runner-scale-set \
#     --namespace arc-runners \
#     -f arc-runner-set-values.yaml
#
# Prerequisites:
#   - ARC controller installed (gha-runner-scale-set-controller chart)
#   - GitHub App or PAT configured for runner registration
#   - arc-pnpm-store PVC pre-provisioned (see arc-pnpm-store-pvc.yaml)

githubConfigUrl: "https://github.com/alkem-io/server"
# githubConfigSecret: <your-github-config-secret>  # Contains GitHub App or PAT credentials

# Runner pods are ephemeral (one pod per job, destroyed after completion)
# maxRunners / minRunners control autoscaling bounds
maxRunners: 5
minRunners: 0

template:
  spec:
    nodeSelector:
      # Pin all runner pods to a single node for RWO PVC sharing.
      # Replace with your actual runner node hostname.
      kubernetes.io/hostname: "<runner-node-name>"

    initContainers:
      # Required by ARC: copies Docker externals to shared volume
      - name: init-dind-externals
        image: ghcr.io/actions/actions-runner:2.321.0  # Pin per Constitution P9; verify latest at https://github.com/actions/runner/releases
        command: ["cp", "-r", "/home/runner/externals/.", "/home/runner/tmpDir/"]
        volumeMounts:
          - name: dind-externals
            mountPath: /home/runner/tmpDir

    containers:
      # --- Runner container ---
      - name: runner
        image: ghcr.io/actions/actions-runner:2.321.0  # Pin per Constitution P9; verify latest at https://github.com/actions/runner/releases
        # Phase 2: Replace with custom image from GHCR:
        # image: ghcr.io/alkem-io/arc-runner:latest
        env:
          - name: DOCKER_HOST
            value: "unix:///var/run/docker.sock"
          - name: RUNNER_WAIT_FOR_DOCKER_IN_SECONDS
            value: "120"
          # pnpm store cache: point pnpm to the PVC mount
          - name: npm_config_store_dir
            value: "/opt/cache/pnpm-store"
        volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: dind-sock
            mountPath: /var/run
          - name: dind-externals
            mountPath: /home/runner/externals
          - name: pnpm-store-cache
            mountPath: /opt/cache/pnpm-store

      # --- DinD sidecar (enable before PR 3 â€” comment out this entire block for PR 1/PR 2) ---
      - name: dind
        image: docker:27.5.1-dind  # Pin per Constitution P9
        args:
          - dockerd
          - --host=unix:///var/run/docker.sock
          - --group=123
        securityContext:
          privileged: true  # Required for Docker daemon + QEMU binfmt registration
        volumeMounts:
          - name: work
            mountPath: /home/runner/_work
          - name: dind-sock
            mountPath: /var/run
          - name: dind-externals
            mountPath: /home/runner/externals
      # --- End DinD sidecar block ---

    volumes:
      # ARC-managed ephemeral volumes
      - name: work
        emptyDir: {}
      # --- DinD volumes (comment out alongside DinD sidecar for PR 1/PR 2) ---
      - name: dind-sock
        emptyDir: {}
      - name: dind-externals
        emptyDir: {}
      # --- End DinD volumes ---
      # Persistent pnpm store cache (pre-provisioned RWO PVC)
      - name: pnpm-store-cache
        persistentVolumeClaim:
          claimName: arc-pnpm-store
