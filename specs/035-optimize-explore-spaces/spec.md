# Feature Specification: Optimize ExploreAllSpaces Query

**Feature Branch**: `035-optimize-explore-spaces`
**Created**: 2026-02-16
**Status**: Draft
**Input**: User description: "Reduce excessive PostgreSQL spans generated by the ExploreAllSpaces GraphQL query, as observed via Elastic APM. PostgreSQL hit reduction is the priority. Redis is acceptable for frequent hits but should not become the new bottleneck. The query is only executed by unauthenticated users."

### APM Baseline (observed)

- **Average `transaction.span_count.started`**: 494 (across 227 invocations)
- This includes all span types: PostgreSQL, Redis, and framework spans combined
- Default query parameters: limit=30 spaces, daysOld=30 days

## User Scenarios & Testing _(mandatory)_

### User Story 1 - Faster Space Exploration Page Load (Priority: P1)

An unauthenticated visitor opens the Alkemio platform's Explore page, which triggers the `ExploreAllSpaces` query. The system returns the list of active spaces with their profiles, visuals, tagsets, and lead contributors. APM data shows this query averages 494 total spans (PostgreSQL + Redis + framework) across 227 invocations. The primary contributor to the excessive PostgreSQL spans is the N+1 credential-lookup pattern for lead users and lead organizations — 60 individual queries for the default 30-space result set. After optimization, these are replaced with batched queries.

**Why this priority**: This is the core problem. Every unauthenticated visit to the Explore page triggers this query. Reducing PostgreSQL spans directly improves page load time for the most common entry point and reduces database pressure on the most frequently executed public query.

**Independent Test**: Can be fully tested by executing the `ExploreAllSpaces` query and comparing `transaction.span_count.started` in Elastic APM traces before and after optimization.

**Acceptance Scenarios**:

1. **Given** the Explore page is loaded by an unauthenticated user, **When** the `ExploreAllSpaces` query executes for 30 spaces (default), **Then** the average `transaction.span_count.started` is measurably reduced from the 494 baseline.
2. **Given** the Explore page is loaded by an unauthenticated user, **When** the `ExploreAllSpaces` query returns results, **Then** all fields (profiles, visuals, tagsets, membership lead users and organizations) contain the same data as before optimization.
3. **Given** the system is under normal load, **When** multiple unauthenticated users request the Explore page concurrently, **Then** database connection pool usage does not spike as it does today.

---

### User Story 2 - Batched Lead Contributor Loading (Priority: P1)

When the Explore page displays lead users and lead organizations for each space, the system currently executes individual database queries per space to resolve these (N+1 pattern). For 30 spaces, this means 60 individual credential-lookup queries (30 for lead users + 30 for lead organizations). After optimization, lead contributor data for all spaces is fetched in batched queries, eliminating the N+1 problem.

**Why this priority**: Lead users and lead organizations account for 60 of the PostgreSQL spans. Replacing these with 2 batched queries (1 for users, 1 for organizations) is the single largest reduction available.

**Independent Test**: Can be tested by querying `ExploreAllSpaces` with the `membership { leadUsers, leadOrganizations }` fragment and verifying that the number of credential-lookup queries scales as O(1) rather than O(N) with the number of spaces.

**Acceptance Scenarios**:

1. **Given** 30 spaces are returned by `exploreSpaces`, **When** lead users are resolved for all spaces, **Then** no more than 2 PostgreSQL queries are executed for all lead user data combined (down from 30).
2. **Given** 30 spaces are returned by `exploreSpaces`, **When** lead organizations are resolved for all spaces, **Then** no more than 2 PostgreSQL queries are executed for all lead organization data combined (down from 30).
3. **Given** a space has no lead users or organizations, **When** the membership is resolved, **Then** empty arrays are returned without triggering unnecessary queries.

---

### User Story 3 - Stable Performance Under Varying Space Counts (Priority: P2)

As the number of active spaces grows on the platform, the Explore page query performance should remain predictable. The number of database queries should not grow linearly with the number of spaces returned.

**Why this priority**: Ensures the optimization is sustainable. Without this, the problem will recur as the platform scales.

**Independent Test**: Can be tested by varying the `limit` parameter (e.g., 10, 20, 30 spaces) and verifying that query count grows sub-linearly or remains constant.

**Acceptance Scenarios**:

1. **Given** the `exploreSpaces` query requests 30 spaces, **When** the query executes, **Then** the batched portion of PostgreSQL queries (excluding URL generation) remains constant regardless of space count.
2. **Given** the query limit is increased from 10 to 30, **When** comparing APM traces, **Then** the number of credential-related database spans does not increase (remains at 2 total — 1 for users, 1 for organizations).

---

### Edge Cases

- What happens when a space has no lead users or lead organizations? The system should return empty arrays without additional queries.
- What happens when the DataLoader batch includes spaces where the community or roleSet is missing? The system should gracefully handle null communities without throwing errors.
- What happens when the `exploreSpaces` query returns fewer spaces than requested (due to visibility/authorization filtering)? The batch loaders should handle variable-size batches correctly.
- What happens when the activity table has no recent entries? The query should return an empty list without errors.

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: System MUST return identical data for the `ExploreAllSpaces` query before and after optimization (no behavioral change to the GraphQL response).
- **FR-002**: System MUST batch-load lead users across all spaces in the query result instead of querying per-space.
- **FR-003**: System MUST batch-load lead organizations across all spaces in the query result instead of querying per-space.
- **FR-004**: New batch-loading mechanisms MUST be generic and reusable across all query paths that resolve lead users or lead organizations — not scoped to the `exploreSpaces` query alone.
- **FR-005**: System MUST NOT introduce new N+1 query patterns in the resolution of any field in the `ExploreAllSpaces` query path.
- **FR-006**: System MUST maintain correct authorization behavior — unauthenticated users should only see data they are permitted to access.
- **FR-007**: System MUST NOT shift the database load problem to Redis (e.g., by adding heavy Redis caching that masks but doesn't fix the inefficient query pattern).
- **FR-008**: System MUST preserve the activity-based ordering of spaces (most active first).

### Explicit Scope Exclusions

- **Profile URL generation N+1**: The `url` field on Profile triggers an unbatched DB query per profile (~150 additional PostgreSQL spans on cold cache). This is mitigated by existing Redis caching and is excluded from this optimization scope.

### Non-Functional Requirements

- **NFR-001**: The average `transaction.span_count.started` for the `ExploreAllSpaces` query MUST be measurably reduced from the 494-span baseline (target: eliminate ~58 credential-lookup PostgreSQL spans).
- **NFR-002**: The p95 response time for the `ExploreAllSpaces` query SHOULD improve measurably.
- **NFR-003**: The optimization MUST NOT increase memory usage per request beyond 20% of current baseline.

### Key Entities

- **Space**: Top-level container with about, community, collaboration relations. The query targets Level 0 (L0) spaces with ACTIVE visibility.
- **SpaceAbout**: Holds profile reference, linked to Space via OneToOne relation.
- **Profile**: Contains displayName, tagline, url, visuals, and tagsets.
- **Visual**: Image assets (AVATAR, CARD types) associated with profiles.
- **Tagset**: Tag collections associated with profiles.
- **Community / RoleSet**: Community membership structure; RoleSet contains role definitions with credential references.
- **Credential**: Links users/organizations to roles within a space's community. Used to resolve lead users and lead organizations.

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: The average `transaction.span_count.started` for the `ExploreAllSpaces` query drops measurably from the 494-span baseline (target: ~436 or lower, reflecting elimination of ~58 per-space credential lookups replaced by 2 batched queries).
- **SC-002**: The number of credential-related PostgreSQL spans remains constant (2) regardless of how many spaces the query returns (10, 20, or 30).
- **SC-003**: The Explore page loads in under 2 seconds for unauthenticated users on standard connections (p95).
- **SC-004**: No regression in data correctness — all fields in the ExploreSpaces fragment return identical values pre- and post-optimization.

## Assumptions

- The default `limit` for `exploreSpaces` is 30 spaces, and `daysOld` is 30 days.
- The query is exclusively called by unauthenticated users, meaning authorization checks will consistently evaluate against public/anonymous privileges.
- The existing DataLoader infrastructure (request-scoped, using Facebook's DataLoader library) is the correct mechanism for batching — no new caching layer is needed. New DataLoaders follow existing patterns (e.g., `SpaceCommunityWithRoleSetLoaderCreator`) and are registered generically in `LoaderCreatorModule`.
- The `myMembershipStatus` field already short-circuits for unauthenticated users (returns `NOT_MEMBER` with 0 DB queries). Confirmed via code review.
- Redis is already used for other purposes in the system and is acceptable for auxiliary caching, but the primary optimization must happen at the query-batching level.
- No GraphQL schema changes are required — this is a pure backend optimization.
- Profile URL generation N+1 is out of scope; its existing Redis cache mitigation is acceptable.