# Synapse Homeserver Configuration
# For more information, see: https://element-hq.github.io/synapse/latest/usage/configuration/config_documentation.html

server_name: "alkemio.matrix.host"
# Public base URL - CRITICAL for SSO redirects
# This tells Synapse what URL to use when generating redirect URLs
public_baseurl: "http://localhost:8008"
pid_file: /data/homeserver.pid
web_client_location: https://app.element.io/

listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    resources:
      - names: [client, federation]
        compress: false

database:
  name: psycopg2
  args:
    user: synapse
    password: synapse
    database: synapse
    host: postgres
    port: 5432
    cp_min: 5
    cp_max: 10

log_config: "/data/log.config"

media_store_path: /data/media_store
uploads_path: /data/uploads

max_upload_size: 50M
max_image_pixels: 32M

dynamic_thumbnails: false

url_preview_enabled: false

enable_registration: true
enable_registration_without_verification: true

# Password authentication configuration
# Disabled to enforce SSO-only authentication (FR-001, FR-002)
#password_config:
#  enabled: false

# Optional account validity configuration. This allows for accounts to be denied
# any request after a given period.
#
# Once this feature is enabled, Synapse will look for registered users without an
# expiration date at startup and will add one to every account it found using the
# current settings at that time.
# This means that, if a validity period is set, and Synapse is restarted (it will
# then derive an expiration date from the current validity period), and some time
# after that the validity period changes and Synapse is restarted, the users'
# expiration dates won't be updated unless their account is manually renewed. This
# date will be randomly selected within a range [now + period - d ; now + period],
# where d is equal to 10% of the validity period.
#
account_validity:
# The account validity feature is disabled by default. Uncomment the
# following line to enable it.
#
#enabled: true

# The period after which an account is valid after its registration. When
# renewing the account, its validity period will be extended by this amount
# of time. This parameter is required when using the account validity
# feature.
#
#period: 6w

# The amount of time before an account's expiry date at which Synapse will
# send an email to the account's email address with a renewal link. By
# default, no such emails are sent.
#
# If you enable this setting, you will also need to fill out the 'email' and
# 'public_baseurl' configuration sections.
#
#renew_at: 1w

# The subject of the email sent out with the renewal link. '%(app)s' can be
# used as a placeholder for the 'app_name' parameter from the 'email'
# section.
#
# Note that the placeholder must be written '%(app)s', including the
# trailing 's'.
#
# If this is not set, a default value is used.
#
#renew_email_subject: "Renew your %(app)s account"

# Directory in which Synapse will try to find templates for the HTML files to
# serve to the user when trying to renew an account. If not set, default
# templates from within the Synapse package will be used.
#
#template_dir: "res/templates"

# File within 'template_dir' giving the HTML to be displayed to the user after
# they successfully renewed their account. If not set, default text is used.
#
#account_renewed_html_path: "account_renewed.html"

# File within 'template_dir' giving the HTML to be displayed when the user
# tries to renew an account with an invalid renewal token. If not set,
# default text is used.
#
#invalid_token_html_path: "invalid_token.html"

# Time that a user's session remains valid for, after they log in.
#
# Note that this is not currently compatible with guest logins.
#
# Note also that this is calculated at login time: changes are not applied
# retrospectively to users who have already logged in.
#
# By default, this is infinite.
#
#session_lifetime: 24h

# The user must provide all of the below types of 3PID when registering.
#
#registrations_require_3pid:
#  - email
#  - msisdn

# Explicitly disable asking for MSISDNs from the registration
# flow (overrides registrations_require_3pid if MSISDNs are set as required)
#
#disable_msisdn_registration: true

# Mandate that users are only allowed to associate certain formats of
# 3PIDs with accounts on this server.
#
#allowed_local_3pids:
#  - medium: email
#    pattern: '^[^@]+@matrix\.org$'
#  - medium: email
#    pattern: '^[^@]+@vector\.im$'
#  - medium: msisdn
#    pattern: '\+44'

# Enable 3PIDs lookup requests to identity servers from this server.
#
#enable_3pid_lookup: true

# If set, allows registration of standard or admin accounts by anyone who
# has the shared secret, even if registration is otherwise disabled.
#
registration_shared_secret: n#P.uIl8IDOYPR-fiLzDoFw9ZPvTIlYg7*F9*~eaDZFK#;.KRg

# Set the number of bcrypt rounds used to generate password hash.
# Larger numbers increase the work factor needed to generate the hash.
# The default number is 12 (which equates to 2^12 rounds).
# N.B. that increasing this will exponentially increase the time required
# to register or login - e.g. 24 => 2^24 rounds which will take >20 mins.
#
#bcrypt_rounds: 12

# Allows users to register as guests without a password/email/etc, and
# participate in rooms hosted on this server which have been made
# accessible to anonymous users.
#
#allow_guest_access: false

# The identity server which we suggest that clients should use when users log
# in on this server.
#
# (By default, no suggestion is made, so it is left up to the client.
# This setting is ignored unless public_baseurl is also set.)
#
#default_identity_server: https://matrix.org

# Handle threepid (email/phone etc) registration and password resets through a set of
# *trusted* identity servers. Note that this allows the configured identity server to
# reset passwords for accounts!
#
# Be aware that if `email` is not set, and SMTP options have not been
# configured in the email config block, registration and user password resets via
# email will be globally disabled.
#
# Additionally, if `msisdn` is not set, registration and password resets via msisdn
# will be disabled regardless, and users will not be able to associate an msisdn
# identifier to their account. This is due to Synapse currently not supporting
# any method of sending SMS messages on its own.
#
# To enable using an identity server for operations regarding a particular third-party
# identifier type, set the value to the URL of that identity server as shown in the
# examples below.
#
# Servers handling the these requests must answer the `/requestToken` endpoints defined
# by the Matrix Identity Service API specification:
# https://matrix.org/docs/spec/identity_service/latest
#
# If a delegate is specified, the config option public_baseurl must also be filled out.
#
account_threepid_delegates:
#email: https://example.com     # Delegate email sending to example.com
#msisdn: http://localhost:8090  # Delegate SMS sending to this local process

# OIDC SSO Configuration (T012: FR-001, FR-002, FR-005, FR-007, FR-013)
oidc_providers:
  - idp_id: oidc-hydra
    idp_name: "Alkemio SSO"
    # Issuer URL - must match what's accessible from browser (via Traefik)
    issuer: "http://localhost:3000/"
    # Disable automatic discovery due to startup timing issues
    # Use explicit endpoints instead: public for browser, internal for backend
    discover: false
    # Explicit OIDC endpoints (hybrid approach)
    authorization_endpoint: "http://localhost:3000/oauth2/auth"  # Public - accessed by browser
    token_endpoint: "http://hydra:4444/oauth2/token"              # Internal - accessed by Synapse
    userinfo_endpoint: "http://hydra:4444/userinfo"               # Internal - accessed by Synapse
    jwks_uri: "http://hydra:4444/.well-known/jwks.json"          # Internal - accessed by Synapse
    # Allow HTTP for development environment (IMPORTANT: Set to false in production!)
    skip_verification: true
    # OAuth2 client credentials (FR-008)
    client_id: "synapse-client"
    client_secret: "Ihky1jTsQ21uwdJvhjpiF1ZhHArymSZpK6eiZrPKgPo="
    # OIDC scopes (FR-010)
    scopes: ["openid", "profile", "email"]

    # User attribute mapping (FR-005, FR-007)
    user_mapping_provider:
      config:
        # Use email localpart (before @) as Matrix user ID (FR-005)
        # Supports all Kratos authentication methods: password, LinkedIn, Microsoft, GitHub
#        localpart_template: "{{ user.email.split('@')[0] }}"
        localpart_template: "{{ user.agent_id }}"
        # Display name from Kratos traits.name.first and traits.name.last (FR-007)
        display_name_template: "{{ user.given_name }} {{ user.family_name }}"
        # Email from Kratos traits.email (FR-007)
        email_template: "{{ user.email }}"

    # Account linking configuration (FR-013)
    # Allows existing Matrix accounts to be linked with Kratos OIDC authentication
    allow_existing_users: true

    # User profile synchronization method (FR-007)
    user_profile_method: "userinfo_endpoint"

# Token refresh configuration (FR-011, NFR-002)
# Set to 5 minutes (300s) to ensure timely session termination when Kratos accounts are disabled
# This supports FR-015 (account revocation) while maintaining session usability
refresh_token_lifetime: 300s

# Session lifetime (48h to match Kratos session lifespan) (FR-011)
session_lifetime: 48h

# Signing key for tokens
# CRITICAL: In production, this file MUST persist across container restarts!
# The signing key authenticates all access tokens and session tokens.
# If the key changes, ALL user sessions become invalid.
#
# Production deployment requirements:
# - Kubernetes: Use a PersistentVolume for /data directory
# - Docker: Use a named volume (not bind mount) for /data
# - The signing key will be auto-generated on first startup
# - Ensure /data volume has proper backup and disaster recovery
signing_key_path: "/data/alkemio.matrix.host.signing.key"

trusted_key_servers:
  - server_name: "matrix.org"

# Enable metrics for monitoring
enable_metrics: true
metrics_port: 9000

# Report stats
report_stats: false

# Suppress key server warning
suppress_key_server_warning: true

## Ratelimiting ##

# Ratelimiting settings for client actions (registration, login, messaging).
#
# Each ratelimiting configuration is made of two parameters:
#   - per_second: number of requests a client can send per second.
#   - burst_count: number of requests a client can send before being throttled.
#
# Synapse currently uses the following configurations:
#   - one for messages that ratelimits sending based on the account the client
#     is using
#   - one for registration that ratelimits registration requests based on the
#     client's IP address.
#   - one for login that ratelimits login requests based on the client's IP
#     address.
#   - one for login that ratelimits login requests based on the account the
#     client is attempting to log into.
#   - one for login that ratelimits login requests based on the account the
#     client is attempting to log into, based on the amount of failed login
#     attempts for this account.
#   - one for ratelimiting redactions by room admins. If this is not explicitly
#     set then it uses the same ratelimiting as per rc_message. This is useful
#     to allow room admins to deal with abuse quickly.
#   - two for ratelimiting number of rooms a user can join, "local" for when
#     users are joining rooms the server is already in (this is cheap) vs
#     "remote" for when users are trying to join rooms not on the server (which
#     can be more expensive)
#   - one for ratelimiting how often a user or IP can attempt to validate a 3PID.
#   - two for ratelimiting how often invites can be sent in a room or to a
#     specific user.
#
# The defaults are as shown below.
#

rc_message:
  per_second: 10
  burst_count: 30
#
rc_registration:
  per_second: 10
  burst_count: 30
#
rc_login:
  address:
    per_second: 10
    burst_count: 30
  account:
    per_second: 10
    burst_count: 30
  failed_attempts:
    per_second: 2
    burst_count: 3
#
rc_admin_redaction:
  per_second: 5
  burst_count: 50
#
rc_joins:
  local:
    per_second: 5
    burst_count: 10
  remote:
    per_second: 1
    burst_count: 10
#
rc_3pid_validation:
  per_second: 1
  burst_count: 5
#
rc_invites:
  per_room:
    per_second: 5
    burst_count: 10
  per_user:
    per_second: 5
    burst_count: 5

# Ratelimiting settings for incoming federation
#
# The rc_federation configuration is made up of the following settings:
#   - window_size: window size in milliseconds
#   - sleep_limit: number of federation requests from a single server in
#     a window before the server will delay processing the request.
#   - sleep_delay: duration in milliseconds to delay processing events
#     from remote servers by if they go over the sleep limit.
#   - reject_limit: maximum number of concurrent federation requests
#     allowed from a single server
#   - concurrent: number of federation requests to concurrently process
#     from a single server
#
# The defaults are as shown below.
#
#rc_federation:
#  window_size: 1000
#  sleep_limit: 10
#  sleep_delay: 500
#  reject_limit: 50
#  concurrent: 3

# Target outgoing federation transaction frequency for sending read-receipts,
# per-room.
#
# If we end up trying to send out more read-receipts, they will get buffered up
# into fewer transactions.
#
#federation_rr_transactions_per_room_per_second: 50


