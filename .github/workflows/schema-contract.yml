name: Schema Contract

on:
  pull_request:
    paths:
      - 'src/**'
      - 'specs/002-schema-contract-diffing/**'
      - '.github/workflows/schema-contract.yml'
      - 'package.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'

jobs:
  diff-and-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # need full metadata for label-based baseline detection

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Generate schema snapshot (lightweight)
        env:
          SCHEMA_BOOTSTRAP_LIGHT: '1'
          SCHEMA_SNAPSHOT_FORCE_SUCCESS: '1'
        run: npx ts-node -r tsconfig-paths/register scripts/schema/generate-schema.snapshot.ts schema.graphql

      - name: Determine baseline branch
        id: baseline_ref
        run: |
          # Priority order:
          # 1. Explicit env BASELINE_BRANCH (can be set via workflow_dispatch or repository env)
          # 2. PR label schema-base:<branch>
          # 3. GITHUB_BASE_REF
          BASELINE="${BASELINE_BRANCH}"
          if [ -z "$BASELINE" ]; then
            echo "Scanning PR labels for schema-base:* override..."
            labels=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
              -H 'Accept: application/vnd.github+json' \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" | jq -r '.[].name') || true
            for l in $labels; do
              case "$l" in
                schema-base:*) BASELINE="${l#schema-base:}"; echo "Found label override: $l"; break;;
              esac
            done
          fi
          if [ -z "$BASELINE" ]; then
            BASELINE="${GITHUB_BASE_REF}"
            echo "Defaulting baseline to GITHUB_BASE_REF=$BASELINE"
          else
            echo "Using custom baseline branch: $BASELINE"
          fi
          echo "baseline=$BASELINE" >> $GITHUB_OUTPUT

      - name: Retrieve baseline schema (if available)
        run: |
          mkdir -p tmp
          BASELINE="${{ steps.baseline_ref.outputs.baseline }}"
          echo "Baseline branch resolved to: $BASELINE"
          git fetch origin "$BASELINE" --depth=1 || echo "Fetch baseline branch failed (continuing)."
          if git show "origin/$BASELINE:schema-baseline.graphql" >/dev/null 2>&1; then
            git show "origin/$BASELINE:schema-baseline.graphql" > tmp/prev.schema.graphql
            echo "Baseline schema obtained from origin/$BASELINE:schema-baseline.graphql"
          elif git show "origin/$BASELINE:schema.graphql" >/dev/null 2>&1; then
            git show "origin/$BASELINE:schema.graphql" > tmp/prev.schema.graphql
            echo "Fallback baseline derived from origin/$BASELINE:schema.graphql"
          else
            echo "WARNING: No baseline schema found on $BASELINE; this run initializes baseline (no diff)."
          fi

      - name: Run diff
        run: npx ts-node scripts/schema/diff-schema.ts --old tmp/prev.schema.graphql --current schema.graphql --out change-report.json --deprecations deprecations.json || true

      - name: Gate evaluation (non-blocking summary)
        run: npx ts-node scripts/schema/schema-gate.ts change-report.json || true

      - name: Generate PR comment body
        id: pr_comment
        run: |
          npx ts-node scripts/schema/post-pr-comment.ts change-report.json > pr-comment.md
          echo 'body<<EOF' >> $GITHUB_OUTPUT
          cat pr-comment.md >> $GITHUB_OUTPUT || echo 'No report' >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: schema-artifacts
          path: |
            change-report.json
            deprecations.json
            schema.graphql
            pr-comment.md

      - name: Post sticky PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: schema-contract
          message: ${{ steps.pr_comment.outputs.body }}

      - name: Enforce gate
        run: npx ts-node scripts/schema/schema-gate.ts change-report.json
