name: Schema Contract

on:
  pull_request:
    paths:
      - 'src/**'
      - 'specs/002-schema-contract-diffing/**'
      - '.github/workflows/schema-contract.yml'
      - 'package.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'

jobs:
  diff-and-validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      # Always run schema generation with the lightweight bootstrap inside CI builds.
      # See specs/002-schema-contract-diffing/spec.md (FR-021).
      SCHEMA_BOOTSTRAP_LIGHT: '1'
      # Override evaluation reads CODEOWNERS from this path.
      SCHEMA_OVERRIDE_CODEOWNERS_PATH: '.github/CODEOWNERS'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # need full metadata for label-based baseline detection

      - name: Bootstrap pnpm for cache
        run: |
          corepack enable
          corepack prepare pnpm@10.17.1 --activate

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Collect schema override reviews
        if: github.event_name == 'pull_request'
        id: collect_reviews
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const pullNumber = context.payload?.pull_request?.number;
            if (!pullNumber) {
              core.info('No pull request number detected; returning empty reviews array');
              return '';
            }
            const raw = await github.paginate(
              github.rest.pulls.listReviews,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pullNumber,
                per_page: 100,
              }
            );
            const reviews = raw.map(r => ({
              reviewer: r.user?.login ?? '',
              body: r.body ?? '',
              state: r.state ?? '',
            }));
            const fs = require('fs');
            const path = require('path');
            const file = path.join(process.cwd(), 'tmp', 'schema-override-reviews.json');
            fs.mkdirSync(path.dirname(file), { recursive: true });
            fs.writeFileSync(file, JSON.stringify(reviews));
            core.info(`Wrote ${reviews.length} review(s) to ${file}`);
            return file;

      - name: Generate schema snapshot (lightweight)
        env:
          SCHEMA_SNAPSHOT_DEBUG: '1'
        run: |
          set -o pipefail
          pnpm exec ts-node -r tsconfig-paths/register scripts/schema/generate-schema.snapshot.ts schema.graphql 2>&1 | tee snapshot.log

      - name: Verify snapshot output
        run: |
          if [ ! -f schema.graphql ]; then
            echo "ERROR: schema.graphql not produced" >&2
            echo "--- snapshot.log (tail) ---" >&2
            tail -n 200 snapshot.log || true
            exit 1
          fi
          size=$(wc -c < schema.graphql)
            if [ "$size" -lt 40 ]; then
            echo "WARNING: schema.graphql extremely small ($size bytes); may be placeholder." >&2
          fi
          echo "Snapshot size: $size bytes"
          echo "Snapshot MD5: $(md5sum schema.graphql | awk '{print $1}')"
          head -n 5 schema.graphql
          echo "SNAPSHOT_DIAG_MD5=$(md5sum schema.graphql | awk '{print $1}')" >> $GITHUB_ENV
          echo "SNAPSHOT_DIAG_SIZE=$size" >> $GITHUB_ENV
          echo "SNAPSHOT_DIAG_HEAD=$(head -n 1 schema.graphql | sed 's/[^A-Za-z0-9_:#-]/_/g')" >> $GITHUB_ENV

      - name: Determine baseline branch
        id: baseline_ref
        run: |
          # Priority order:
          # 1. Explicit env BASELINE_BRANCH (can be set via workflow_dispatch or repository env)
          # 2. PR label schema-base:<branch>
          # 3. GITHUB_BASE_REF
          BASELINE="${BASELINE_BRANCH}"
          if [ -z "$BASELINE" ]; then
            echo "Scanning PR labels for schema-base:* override..."
            labels=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
              -H 'Accept: application/vnd.github+json' \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" | jq -r '.[].name') || true
            for l in $labels; do
              case "$l" in
                schema-base:*) BASELINE="${l#schema-base:}"; echo "Found label override: $l"; break;;
              esac
            done
          fi
          if [ -z "$BASELINE" ]; then
            BASELINE="${GITHUB_BASE_REF}"
            echo "Defaulting baseline to GITHUB_BASE_REF=$BASELINE"
          else
            echo "Using custom baseline branch: $BASELINE"
          fi
          echo "baseline=$BASELINE" >> $GITHUB_OUTPUT

      - name: Retrieve baseline schema (if available)
        run: |
          mkdir -p tmp
          BASELINE="${{ steps.baseline_ref.outputs.baseline }}"
          echo "Baseline branch resolved to: $BASELINE"
          git fetch origin "$BASELINE" --depth=1 || echo "Fetch baseline branch failed (continuing)."
          if git show "origin/$BASELINE:schema-baseline.graphql" >/dev/null 2>&1; then
            git show "origin/$BASELINE:schema-baseline.graphql" > tmp/prev.schema.graphql
            echo "Baseline schema obtained from origin/$BASELINE:schema-baseline.graphql"
          elif git show "origin/$BASELINE:schema.graphql" >/dev/null 2>&1; then
            git show "origin/$BASELINE:schema.graphql" > tmp/prev.schema.graphql
            echo "Fallback baseline derived from origin/$BASELINE:schema.graphql"
          else
            echo "WARNING: No baseline schema found on $BASELINE; this run initializes baseline (no diff)."
            # Mark initialization run so later steps can annotate the PR comment.
            echo "SCHEMA_INIT_RUN=1" >> $GITHUB_ENV
            # Create an explicit placeholder previous schema file so diff step has a path. Empty file is treated as zero-def schema.
            : > tmp/prev.schema.graphql
          fi

      - name: Run diff
        env:
          SCHEMA_OVERRIDE_REVIEWS_FILE: ${{ steps.collect_reviews.outputs.result }}
        run: pnpm exec ts-node scripts/schema/diff-schema.ts --old tmp/prev.schema.graphql --current schema.graphql --out change-report.json --deprecations deprecations.json || true

      - name: Gate evaluation (non-blocking summary)
        env:
          SCHEMA_OVERRIDE_REVIEWS_FILE: ${{ steps.collect_reviews.outputs.result }}
        run: pnpm exec ts-node scripts/schema/schema-gate.ts change-report.json || true

      - name: Prepare schema artifacts
        run: |
          mkdir -p tmp
          cp schema.graphql tmp/current.schema.graphql
          if [ -f tmp/prev.schema.graphql ]; then
            cp tmp/prev.schema.graphql tmp/previous.schema.graphql
          fi

      - name: Generate PR comment body
        id: pr_comment
        run: |
          pnpm exec ts-node scripts/schema/post-pr-comment.ts change-report.json > pr-comment.md
          if [ "$SCHEMA_INIT_RUN" = "1" ]; then
            echo "" >> pr-comment.md
            echo "> ℹ️ No baseline schema was found for branch '${{ steps.baseline_ref.outputs.baseline }}'. This run is treated as an INITIALIZATION run; no additive/breaking differences are listed. Commit a baseline file (schema-baseline.graphql) to that branch (or apply a schema-base:<branch> label) to enable diffs on subsequent PRs." >> pr-comment.md
          fi
          echo "" >> pr-comment.md
          echo "---" >> pr-comment.md
          echo "Baseline branch: ${{ steps.baseline_ref.outputs.baseline }}" >> pr-comment.md
          if [ -n "$SNAPSHOT_DIAG_MD5" ]; then
            echo "Current schema MD5: $SNAPSHOT_DIAG_MD5 (size $SNAPSHOT_DIAG_SIZE)" >> pr-comment.md
          fi
          if [ -f tmp/prev.schema.graphql ]; then
            echo "Previous schema MD5: $(md5sum tmp/prev.schema.graphql | awk '{print $1}')" >> pr-comment.md
          fi
          echo 'body<<EOF' >> $GITHUB_OUTPUT
          cat pr-comment.md >> $GITHUB_OUTPUT || echo 'No report' >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: schema-artifacts
          path: |
            change-report.json
            deprecations.json
            schema.graphql
            snapshot.log
            pr-comment.md
            tmp/current.schema.graphql
            tmp/previous.schema.graphql

      - name: Post sticky PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: schema-contract
          message: ${{ steps.pr_comment.outputs.body }}

      - name: Enforce gate
        env:
          SCHEMA_OVERRIDE_REVIEWS_FILE: ${{ steps.collect_reviews.outputs.result }}
        run: pnpm exec ts-node scripts/schema/schema-gate.ts change-report.json
