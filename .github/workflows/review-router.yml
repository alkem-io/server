name: PR Review Router

# Controls when the workflow runs
on:
  pull_request:
    types: [opened, reopened, synchronize] # Run when a PR is opened, reopened, or updated

jobs:
  route_review:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout the repository code
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        # Fetch depth 0 is important to get the base branch reference for diffing
        fetch-depth: 0
    # 2. Setup Python environment
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    # 3. Cache Python packages
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    # 4. Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # pip install -r requirements.txt # Uncomment if you use external packages
    # 5. Extract PR metadata and run the Python script (REAL LOGIC)
    - name: Run Review Router (Dynamic Metrics)
      id: router
      run: |
        # 1. Fetch the base branch to enable accurate diff calculation
        # We check out the PR branch, now we fetch the target branch for comparison
        git fetch origin ${{ github.event.pull_request.base.ref }}

        # 2. Get the PR title
        PR_TITLE=$(jq -r '.pull_request.title' "${GITHUB_EVENT_PATH}")

        # 3. Use 'git diff --numstat' to get stats between the base branch and the PR head
        # Format: <lines added>\t<lines removed>\t<file name>
        DIFF_STATS=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }} ${{ github.sha }})

        # Initialize counters and file list
        LOC=0
        FILES=0
        # We use a newline character (\n) as the separator for the list of files
        CHANGED_PATHS=""

        # 4. Process DIFF_STATS line by line
        while IFS=$'\t' read -r ADDED DELETED FILE; do
            # Skip if line is empty or not a stat line
            if [ -z "$FILE" ]; then
                continue
            fi

            # Ignore binary files or files with only renames
            if [[ "$ADDED" != "-" && "$DELETED" != "-" ]]; then
                # Total LOC changed = Additions + Deletions
                LOC=$((LOC + ADDED + DELETED))
                FILES=$((FILES + 1))
                # Accumulate file paths, separated by a newline
                CHANGED_PATHS="${CHANGED_PATHS}${FILE}\n"
            fi
        done <<< "$DIFF_STATS"

        echo "Calculated LOC: ${LOC}, Files: ${FILES}"

        # 5. Execute the Python script with real data
        # We pass the accumulated file paths string as a single, quoted argument
        OUTPUT=$(python review_router.py "${PR_TITLE}" "${LOC}" "${FILES}" "${CHANGED_PATHS}")

        # Split the output (e.g., "HUMAN_AUGMENTED_LLM|team-reviewer")
        REVIEW_TYPE=$(echo $OUTPUT | cut -d'|' -f1)
        REVIEWER=$(echo $OUTPUT | cut -d'|' -f2)

        # Make the outputs available to subsequent steps
        echo "review_type=${REVIEW_TYPE}" >> $GITHUB_OUTPUT
        echo "reviewer=${REVIEWER}" >> $GITHUB_OUTPUT
    # 6. Post Decision Comment (using native github-script)
    - name: Post Decision Comment (Native)
      uses: actions/github-script@v7
      with:
        script: |
          const reviewType = core.getInput('review_type');
          const reviewer = core.getInput('reviewer');
          let commentBody;

          // Generate the Markdown comment body based on the review type
          if (reviewType === 'LLM_ONLY') {
            commentBody = `
              ## ü§ñ Review Routing Decision: LLM Auto-Approval

              ### ‚úÖ Recommendation: **LLM_ONLY**

              This PR is considered **low-risk** and qualifies for automatic LLM approval.

              **Why:**
              * The change is highly focused (e.g., small LOC change, few files).
              * The PR title contains low-risk keywords like \`docs\`, \`style\`, or \`typo\`.
              * No critical system files (e.g., security, authentication, deployment config) were modified.

              No human review is mandatory.
            `;
          } else if (reviewType === 'HUMAN_ONLY') {
            commentBody = `
              ## üö® Review Routing Decision: Mandatory Human Review

              ### üõë Recommendation: **HUMAN_ONLY**

              This change is classified as **high-risk** and requires explicit approval by **@${reviewer}**.

              **Why:**
              * The PR size is large (over 100 LOC changed or 10 files modified).
              * The PR touches **critical system files** (e.g., \`auth/\`, \`production.yml\`, CI/CD scripts).
              * The PR title contains high-risk keywords like \`security\`, \`payment\`, or \`database migration\`.

              The designated reviewer must perform a full, in-depth manual review.
            `;
          } else { // HUMAN_AUGMENTED_LLM
            commentBody = `
              ## üß† Review Routing Decision: Hybrid Approach

              ### ü§ù Recommendation: **HUMAN_AUGMENTED_LLM**

              This PR is of **moderate scope**. It will receive initial checks from the LLM, but requires final sign-off from a human reviewer (**@${reviewer}**).

              **Why:**
              * The change is too large or complex for full automation (e.g., exceeding 20 LOC or 3 files).
              * The change does not meet the criteria for critically high risk (no critical path files or high-risk keywords).
              * The human reviewer will focus on validating **business logic** and **architectural impact**, while the LLM handles surface-level checks.
            `;
          }

          # Post the comment using the native GitHub REST API
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody.trim()
          });
        github-token: ${{ secrets.GITHUB_TOKEN }}
      env:
        review_type: ${{ steps.router.outputs.review_type }}
        reviewer: ${{ steps.router.outputs.reviewer }}
    # 7. Assign the determined human reviewer
    # ...
    # 8. Add a label for easier filtering in GitHub
    - name: Add Label
      uses: actions/github-script@v7
      with:
        script: |
          const reviewType = core.getInput('review_type');
          let label;
          if (reviewType === 'HUMAN_ONLY') {
            label = 'review/human-mandatory';
          } else if (reviewType === 'LLM_ONLY') {
            label = 'review/llm-auto-candidate';
          } else {
            label = 'review/hybrid-needed';
          }

          github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: [label]
          });
        github-token: ${{ secrets.GITHUB_TOKEN }}
      env:
        review_type: ${{ steps.router.outputs.review_type }}
