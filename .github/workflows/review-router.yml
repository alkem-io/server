name: PR Review Router

# Controls when the workflow runs
on:
  pull_request:
    types: [opened, reopened, synchronize] # Run when a PR is opened, reopened, or updated

jobs:
  route_review:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout the repository code
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        # Fetch depth 0 is important to get the base branch reference for diffing
        fetch-depth: 0
    # 2. Setup Python environment
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
    # 3. Cache Python packages
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    # 4. Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # pip install -r requirements.txt # Uncomment if you use external packages
    # 5. Extract PR metadata and run the Python script (REAL LOGIC)
    - name: Run Review Router (Dynamic Metrics)
      id: router
      run: |
        # 1. Fetch the base branch to enable accurate diff calculation
        # We check out the PR branch, now we fetch the target branch for comparison
        git fetch origin ${{ github.event.pull_request.base.ref }}

        # 2. Get the PR title
        PR_TITLE=$(jq -r '.pull_request.title' "${GITHUB_EVENT_PATH}")

        # 3. Use 'git diff --numstat' to get stats between the base branch and the PR head
        # Format: <lines added>\t<lines removed>\t<file name>
        DIFF_STATS=$(git diff --numstat origin/${{ github.event.pull_request.base.ref }} ${{ github.sha }})

        # Initialize counters and file list
        LOC=0
        FILES=0
        # We use a newline character (\n) as the separator for the list of files
        CHANGED_PATHS=""

        # 4. Process DIFF_STATS line by line
        while IFS=$'\t' read -r ADDED DELETED FILE; do
            # Skip if line is empty or not a stat line
            if [ -z "$FILE" ]; then
                continue
            fi

            # Ignore binary files or files with only renames
            if [[ "$ADDED" != "-" && "$DELETED" != "-" ]]; then
                # Total LOC changed = Additions + Deletions
                LOC=$((LOC + ADDED + DELETED))
                FILES=$((FILES + 1))
                # Accumulate file paths, separated by a newline
                CHANGED_PATHS="${CHANGED_PATHS}${FILE}\n"
            fi
        done <<< "$DIFF_STATS"

        echo "Calculated LOC: ${LOC}, Files: ${FILES}"

        # 5. Execute the Python script with real data
        # We pass the accumulated file paths string as a single, quoted argument
        OUTPUT=$(python review_router.py "${PR_TITLE}" "${LOC}" "${FILES}" "${CHANGED_PATHS}")

        # Split the output (e.g., "HUMAN_AUGMENTED_LLM|team-reviewer")
        REVIEW_TYPE=$(echo $OUTPUT | cut -d'|' -f1)
        REVIEWER=$(echo $OUTPUT | cut -d'|' -f2)

        # Make the outputs available to subsequent steps
        echo "review_type=${REVIEW_TYPE}" >> $GITHUB_OUTPUT
        echo "reviewer=${REVIEWER}" >> $GITHUB_OUTPUT
    # 6. Post Decision Comment (using native github-script)
    - name: Post Decision Comment (Native)
      uses: actions/github-script@v7
      with:
        script: |
          const reviewType = core.getInput('review_type');
          const reviewer = core.getInput('reviewer');
          let commentBody;

          // Generate the Markdown comment body based on the review type
          if (reviewType === 'LLM_ONLY') {
            commentBody = `
              ## ðŸ¤– Review Routing Decision

              The current review type is **LLM_ONLY**.
              âœ… This PR is considered low-risk and qualifies for **LLM auto-approval**.
              No human review is mandatory.
            `;
          } else if (reviewType === 'HUMAN_ONLY') {
            commentBody = `
              ## ðŸ¤– Review Routing Decision

              The current review type is **HUMAN_ONLY**.
              ðŸš¨ **Human Review Required!** This change is high-risk and requires explicit approval by **@${reviewer}**.
            `;
          } else { // HUMAN_AUGMENTED_LLM
            commentBody = `
              ## ðŸ¤– Review Routing Decision

              The current review type is **HUMAN_AUGMENTED_LLM**.
              ðŸ§  **Human-Augmented Review.** The LLM will provide an initial pass, but a human reviewer (**@${reviewer}**) is required for final approval.
            `;
          }

          // Post the comment using the native GitHub REST API
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody.trim()
          });
        github-token: ${{ secrets.GITHUB_TOKEN }}
      env:
        review_type: ${{ steps.router.outputs.review_type }}
        reviewer: ${{ steps.router.outputs.reviewer }}
    # 7. Assign the determined human reviewer
    # ...
    # 8. Add a label for easier filtering in GitHub
    - name: Add Label
      uses: actions/github-script@v7
      with:
        script: |
          const reviewType = core.getInput('review_type');
          let label;
          if (reviewType === 'HUMAN_ONLY') {
            label = 'review/human-mandatory';
          } else if (reviewType === 'LLM_ONLY') {
            label = 'review/llm-auto-candidate';
          } else {
            label = 'review/hybrid-needed';
          }

          github.rest.issues.addLabels({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            labels: [label]
          });
        github-token: ${{ secrets.GITHUB_TOKEN }}
      env:
        review_type: ${{ steps.router.outputs.review_type }}
